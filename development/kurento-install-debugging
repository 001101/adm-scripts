#!/usr/bin/env bash

# Install debugging symbols for Kurento Media Server.



# Shell setup
# -----------

BASEPATH="$(cd -P -- "$(dirname -- "$0")" && pwd -P)"  # Absolute canonical path
# shellcheck source=bash.conf.sh
source "$BASEPATH/../bash.conf.sh" || {
    # Bash options for strict error checking
    set -o errexit -o errtrace -o pipefail -o nounset
}



# Check permissions
# -----------------

[[ "$(id -u)" -eq 0 ]] || {
    echo "ERROR: Please run as root user (or with 'sudo')"
    exit 1
}



# Ask for confirmation
# --------------------

echo "==== Install Kurento debug symbols ===="
echo "This will add the Ubuntu 'dbgsym' repository sources"
echo ""
read -p "Are you sure? Type 'yes': " -r SURE
if [[ "$SURE" != "yes" && "$SURE" != "YES" ]]; then
    echo "Exit ..."
    exit 0
fi



# Add Ubuntu 'dbgsym' repository sources
# --------------------------------------

if [[ -f /etc/upstream-release/lsb-release ]]; then
    source /etc/upstream-release/lsb-release
else
    source /etc/lsb-release
fi

tee /etc/apt/sources.list.d/ddebs.list >/dev/null <<EOF
# Ubuntu '-dbgsym.ddeb' (debug symbols) packages
deb http://ddebs.ubuntu.com ${DISTRIB_CODENAME} main restricted universe multiverse
deb http://ddebs.ubuntu.com ${DISTRIB_CODENAME}-updates main restricted universe multiverse
deb http://ddebs.ubuntu.com ${DISTRIB_CODENAME}-proposed main restricted universe multiverse
EOF

apt-key adv --keyserver keyserver.ubuntu.com --recv-keys F2EDC64DC5AEE1F6B9C621F0C8CAB6595FDFF622

apt-get update



# Install debug symbols
# ---------------------

PACKAGES=(
    # System libraries
    libglib2.0-0-dbgsym
    libsrtp0-dbgsym
    libssl1.0.0-dbgsym

    # Fork packages
    kmsjsoncpp-dbg
    libusrsctp-dbgsym
    libgstreamer1.5-0-dbg
    gstreamer1.5-plugins-base-dbg
    gstreamer1.5-plugins-good-dbg
    gstreamer1.5-plugins-bad-dbg
    gstreamer1.5-plugins-ugly-dbg
    gstreamer1.5-libav-dbg
    openwebrtc-gst-plugins-dbg
    libnice10-dbgsym
    gstreamer1.5-nice-dbgsym

    # Main packages
    kms-jsonrpc-dbg
    kms-core-dbg
    kms-elements-dbg
    kms-filters-dbg
    kurento-media-server-dbg

    # Extra packages
    #kms-chroma-dbg
    #kms-crowddetector-dbg
    #kms-platedetector-dbg
    #kms-pointerdetector-dbg
)

apt-get update \
  && apt-get install --no-install-recommends --yes \
     "${PACKAGES[@]}"

